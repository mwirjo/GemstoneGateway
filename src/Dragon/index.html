<!DOCTYPE html>
<html>

<head>
  <title>D&D Dragon Stat Block Generator</title>
  <style>
    /* All your existing CSS unchanged */
    .stat-block {
      background-color: #fdf1dc;
      border: 1px solid #c9c9c9;
      padding: 15px;
      max-width: 600px;
      font-family: 'Georgia', serif;
      font-size: 14px;
      line-height: 1.4;
      margin: 20px auto;
    }

    .image-placeholder {
      height: 150px;
      background-color: #e0e0e0;
      border: 1px dashed #aaa;
      display: flex;
      justify-content: center;
      align-items: center;
      font-style: italic;
      color: #666;
      margin-bottom: 15px;
      border-radius: 5px;
    }

    .stat-block h1 {
      border-bottom: 2px solid #8A1A23;
      font-size: 24px;
      font-variant: small-caps;
      margin: 0 0 10px 0;
      padding-bottom: 5px;
      color: #8A1A23;
    }

    .stat-block h2 {
      border-bottom: 1px solid #8A1A23;
      font-size: 18px;
      font-variant: small-caps;
      margin: 15px 0 10px 0;
      padding-bottom: 5px;
      color: #8A1A23;
    }

    .stat-block p {
      margin: 5px 0;
    }

    .stat-block .property-line {
      font-weight: bold;
    }

    .stat-block .property-line span {
      font-weight: normal;
    }

    .stat-block .abilities {
      display: flex;
      justify-content: space-around;
      text-align: center;
      margin: 15px 0;
      border-top: 2px solid #8A1A23;
      border-bottom: 2px solid #8A1A23;
      padding: 10px 0;
    }

    .stat-block .ability-score {
      flex: 1;
    }

    .stat-block .ability-score strong {
      display: block;
      font-size: 16px;
    }

    .stat-block .ability-score span {
      font-size: 12px;
      font-style: italic;
    }

    .stat-block .dragon-type-line {
      font-style: italic;
      margin-bottom: 10px;
      color: #8A1A23;
    }

    .dragon-image {
      width: 100%;
      max-height: 150px;
      object-fit: cover;
      border-radius: 5px;
    }
  </style>
</head>

<body>
  <div class="character-container">
    <h1>D&D Dragon Stat Block Generator</h1>
    <label for="givename">Give Name (optional):</label>
    <input type="text" id="givename" placeholder="Enter custom name">
    <button onclick="generateRandomStatBlock()">Generate Dragon Stat Block</button>
    <hr>
    <h2>Generated Stat Block:</h2>
    <div id="statBlockDetails">
      <p>Click "Generate Dragon Stat Block" to load a random dragon.</p>
    </div>
  </div>

  <script>
    let dragonsData = [];

    let dragonImages = {};

    async function loadDragonImages() {
        try {
          const response = await fetch("/json/dragonImages.json");
          dragonImages = await response.json();
          console.log("üñºÔ∏è Dragon images loaded:", dragonImages);
        } catch (error) {
          console.error("‚ùå Failed to load dragon images JSON:", error);
        }
      }


    async function fetchDragonsList() {
      try {
        const response = await fetch('https://www.dnd5eapi.co/api/monsters');
        const data = await response.json();
        dragonsData = data.results.filter(m => m.name.toLowerCase().includes('dragon'));
        console.log(dragonsData)
        console.log(`Loaded ${dragonsData.length} dragons`);
      } catch (error) {
        console.error('Dragons list fetch failed:', error);
      }
    }

    function calculateModifier(score) {
      const mod = Math.floor((score - 10) / 2);
      return mod >= 0 ? `+${mod}` : `${mod}`;
    }

    // ADDED: Detailed console logging for image debugging
    function getDragonImage(dragonName) {
      console.log('üîç ORIGINAL dragon name:', dragonName);
      const normalizedName = dragonName.toLowerCase().trim();
      console.log('üîç NORMALIZED (lowercased):', normalizedName);

      // Check for exact match in dragonImages
      if (dragonImages[normalizedName]) {
        console.log('‚úÖ EXACT MATCH FOUND:', normalizedName, '‚Üí', dragonImages[normalizedName]);
        return dragonImages[normalizedName];
      }

      console.log('‚ùå No exact match. Available keys:', Object.keys(dragonImages));
      console.log('‚ùå Returning fallback image');

      // Fallback with colored placeholder
      return "https://via.placeholder.com/400x150/cccccc/000000?text=No+Image";
    }

    // FIXED: Pass imageUrl to renderStatBlock
    async function generateRandomStatBlock() {
      if (dragonsData.length === 0) {
        await fetchDragonsList();
      }

      const detailsDiv = document.getElementById('statBlockDetails');
      detailsDiv.innerHTML = '<p>Fetching monster data...</p>';

      const randomDragon = dragonsData[Math.floor(Math.random() * dragonsData.length)];

      try {
        const response = await fetch(`https://www.dnd5eapi.co${randomDragon.url}`);
        const monster = await response.json();

        const customName = document.getElementById('givename').value.trim();
        const display_name = customName || monster.name;
        const dragonType = monster.name;

        // FIXED: Call getDragonImage and log result
        const dragonImageUrl = getDragonImage(dragonType);
        console.log('üé® FINAL IMAGE URL:', dragonImageUrl);

        // FIXED: Pass the imageUrl parameter
        detailsDiv.innerHTML = renderStatBlock(monster, display_name, dragonType, dragonImageUrl);
      } catch (error) {
        console.error('Failed to fetch monster details:', error);
        detailsDiv.innerHTML = '<p>Sorry, an error occurred fetching the full stat block.</p>';
      }
    }

    // FIXED: Accept imageUrl parameter
    function renderStatBlock(m, name, type, imageUrl) {
      console.log('üì± Rendering with imageUrl:', imageUrl);

      const renderActions = (actions) => (actions || []).map(action =>
        `<div class="action-item"><strong>${action.name}.</strong> <span>${Array.isArray(action.desc) ? action.desc[0] : action.desc}</span></div>`
      ).join('');

      const formatProficiencies = (proficiencies, filterType) => {
        return (proficiencies || [])
          .filter(p => p.proficiency && p.proficiency.name.includes(filterType))
          .map(p => {
            const namePart = p.proficiency.name.split(': ')[1] || p.proficiency.name.split('Skill: ')[1] || p.proficiency.name;
            return `${namePart} ${calculateModifier(p.value)}`;
          })
          .join(', ') || '‚Äî';
      };

      return `
        <div class="stat-block">
          <div style="text-align: center; margin-bottom: 15px;">
            <img src="${imageUrl}" alt="${type}" class="dragon-image" 
                 onerror="console.log('‚ùå Image failed to load:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';"
                 onload="console.log('‚úÖ Image loaded successfully:', this.src);"
                 style="display: block; max-width: 100%; height: auto;">
            <div class="image-placeholder" style="display: none;">
              Dragon Illustration
            </div>
          </div>
          
          <h1>${name}</h1>
          <p class="dragon-type-line">Dragon Type: ${type}</p>
          <p class="property-line"><span>${m.size} ${m.type}, ${m.alignment}</span></p>
          <hr>
          <p class="property-line"><strong>Armor Class</strong> <span>${Array.isArray(m.armor_class) ? m.armor_class[0].value : m.armor_class}</span></p>
          <p class="property-line"><strong>Hit Points</strong> <span>${m.hit_points} (${m.hit_dice})</span></p>
          <p class="property-line"><strong>Speed</strong> <span>${Object.entries(m.speed || {}).map(([k, v]) => `${k} ${v}`).join(', ')}</span></p>
          <hr>
          <div class="abilities">
            <div class="ability-score"><strong>STR</strong> <span>${m.strength} (${calculateModifier(m.strength)})</span></div>
            <div class="ability-score"><strong>DEX</strong> <span>${m.dexterity} (${calculateModifier(m.dexterity)})</span></div>
            <div class="ability-score"><strong>CON</strong> <span>${m.constitution} (${calculateModifier(m.constitution)})</span></div>
            <div class="ability-score"><strong>INT</strong> <span>${m.intelligence} (${calculateModifier(m.intelligence)})</span></div>
            <div class="ability-score"><strong>WIS</strong> <span>${m.wisdom} (${calculateModifier(m.wisdom)})</span></div>
            <div class="ability-score"><strong>CHA</strong> <span>${m.charisma} (${calculateModifier(m.charisma)})</span></div>
          </div>
          <hr>
          <p class="property-line"><strong>Saving Throws</strong> <span>${formatProficiencies(m.proficiencies, 'Saving Throw')}</span></p>
          <p class="property-line"><strong>Skills</strong> <span>${formatProficiencies(m.proficiencies, 'Skill')}</span></p>
          <p class="property-line"><strong>Damage Immunities</strong> <span>${(m.damage_immunities || []).join(', ') || '‚Äî'}</span></p>
          <p class="property-line"><strong>Condition Immunities</strong> <span>${(m.condition_immunities || []).map(c => c.name).join(', ') || '‚Äî'}</span></p>
          <p class="property-line"><strong>Senses</strong> <span>${m.senses}</span></p>
          <p class="property-line"><strong>Languages</strong> <span>${m.languages}</span></p>
          <p class="property-line"><strong>Challenge</strong> <span>${m.challenge_rating} (${m.xp} XP)</span></p>
          
          ${m.special_abilities && m.special_abilities.length ? `<h2>Special Abilities</h2>${renderActions(m.special_abilities)}` : ''}
          <h2>Actions</h2>
          ${renderActions(m.actions)}
          
          ${m.legendary_actions && m.legendary_actions.length ? `
            <h2>Legendary Actions</h2>
            <p>The ${m.name} can take 3 legendary actions, choosing from the options below. Only one legendary action option can be used at a time and only at the end of another creature's turn. The ${m.name} regains spent legendary actions at the start of its turn.</p>
            ${renderActions(m.legendary_actions)}
          ` : ''}
        </div>
      `;
    }
    loadDragonImages();
    fetchDragonsList();
  </script>
</body>

</html>